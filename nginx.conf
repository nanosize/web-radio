worker_processes auto;
rtmp_auto_push on;
events {}

rtmp {
    server {
        listen 1935;
        listen [::]:1935 ipv6only=on;

        application live {
            live on;
            
            # HLS変換の設定
            hls on;
            hls_path /tmp/hls;           # 生成ファイルの保存場所
            hls_fragment 3;              # 1つの断片(.ts)の長さ(秒)。短いと低遅延だが負荷増
            hls_playlist_length 60;      # プレイリスト(.m3u8)で保持する合計時間(秒)
            
            # 認証が必要な場合はここに追加設定が必要
            # record off;
        }
    }
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    server {
        listen 8080;

        # HLSファイル(.m3u8, .ts)へのアクセス許可
        location /hls {
            # CORS設定（異なるドメインのプレイヤーから再生する場合に必須）
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS';
            
            # キャッシュ無効化（ライブ配信なので最新を取りに行かせる）
            add_header Cache-Control no-cache;

            # コンテンツの場所
            root /tmp;
        }
        
        # 統計情報の表示（オプション）
        location /stat {
            rtmp_stat all;
            rtmp_stat_stylesheet stat.xsl;
        }
        location /stat.xsl {
            root /usr/local/nginx/html;
        }
    }
}